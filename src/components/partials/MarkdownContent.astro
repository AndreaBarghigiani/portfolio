---
interface Props {
  content: string;
  class?: string;
}

const { content, class: className = '' } = Astro.props;
import { marked } from 'marked';

const renderer = new marked.Renderer();

// Style links to look like ExternalLink component
renderer.link = function (token: { href: string; title?: string | null; tokens: any[] }): string {
  const { href, title, tokens } = token;
  const titleAttr = title ? ` title="${title}"` : '';
  const isExternal = href.startsWith('http') || href.startsWith('//');
  const externalAttrs = isExternal ? ' target="_blank" rel="noopener noreferrer"' : '';
  const externalIcon = isExternal
    ? '<svg class="size-2.5 ml-0.5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>'
    : '';
  // Parse the tokens to get the link text
  const text = this.parser?.parseInline?.(tokens) || '';
  return `<a href="${href}" class="text-primary underline inline-flex items-center gap-0.5"${externalAttrs}${titleAttr}>${text}${externalIcon}</a>`;
};

// Process other markdown elements normally
renderer.paragraph = function (token: { tokens?: any[] }): string {
  const text = this.parser?.parseInline?.(token.tokens || []) || '';
  return `<p class="mb-3 leading-relaxed">${text}</p>`;
};

renderer.heading = function (token: { tokens?: any[]; depth: number }): string {
  const { tokens, depth } = token;
  const text = this.parser?.parseInline?.(tokens || []) || '';
  const sizeClass =
    depth === 1 ? 'text-2xl' : depth === 2 ? 'text-xl' : depth === 3 ? 'text-lg' : 'text-base';
  return `<h${depth} class="font-semibold ${sizeClass} mb-2 mt-4">${text}</h${depth}>`;
};

renderer.list = function (token: {
  ordered: boolean;
  start: number | string;
  loose: boolean;
  items: any[];
}): string {
  const { ordered, items } = token;
  const tag = ordered ? 'ol' : 'ul';
  const listClass = ordered ? 'list-decimal list-inside' : 'list-disc list-inside';
  const body = items.map((item) => this.listitem(item)).join('');
  return `<${tag} class="${listClass} mb-3 space-y-1">${body}</${tag}>`;
};

renderer.listitem = function (token: {
  checked?: boolean;
  loose: boolean;
  text: string;
  tokens?: any[];
}): string {
  const text = this.parser?.parseInline?.(token.tokens || []) || '';
  return `<li class="text-sm">${text}</li>`;
};

renderer.code = function (token: { text: string; lang?: string; escaped?: boolean }): string {
  const { text: code, lang: language } = token;
  const validLang = language && /^[a-zA-Z0-9-_]+$/.test(language) ? language : '';
  return `<pre class="text-sm"><code class="language-${validLang}">${code}</code></pre>`;
};

renderer.codespan = function (token: { text: string }): string {
  const { text: code } = token;
  return `<code class="text-xs">${code}</code>`;
};

marked.setOptions({ renderer });
const html = marked(content);
---

<div class={`max-w-none ${className}`} set:html={html} />
